name: Gateway Config Validation

on:
  push:
    paths:
      - 'config/docker-compose*.yml'
      - '.env.example'
      - 'tests/gateway-docker-test.sh'
      - 'tests/unit/gateway-config.test.js'
  pull_request:
    paths:
      - 'config/docker-compose*.yml'
      - '.env.example'

jobs:
  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: docker compose -f config/docker-compose.secure.yml config --quiet

      - name: Check bind mode is Docker-compatible
        run: |
          BIND=$(grep -A1 '"--bind"' config/docker-compose.secure.yml | tail -1 | tr -d ' ",')
          if [[ "$BIND" == "localhost" ]]; then
            echo "::error::Invalid bind mode 'localhost' - use 'lan' for Docker"
            exit 1
          fi
          echo "✓ Bind mode: $BIND"

      - name: Check tmpfs doesn't use variables
        run: |
          if grep -E 'tmpfs:' -A10 config/docker-compose.secure.yml | grep -q '\${.*uid'; then
            echo "::error::tmpfs uses variables - Docker Compose doesn't support this"
            exit 1
          fi
          echo "✓ tmpfs configuration valid"

      - name: Check for hardcoded secrets
        run: |
          if grep -qE '(password|token|secret|key).*=.*[a-zA-Z0-9]{20,}' config/docker-compose.secure.yml; then
            echo "::error::Possible hardcoded secret detected"
            exit 1
          fi
          echo "✓ No hardcoded secrets"

  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test .env
        run: |
          cp config/.env.example .env
          echo "CLAWDBOT_GATEWAY_TOKEN=test-token-ci" >> .env

      - name: Run gateway config tests
        run: ./tests/gateway-docker-test.sh || true  # Don't fail on runtime tests

  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci || npm install yaml jest

      - name: Run unit tests
        run: npm test -- tests/unit/gateway-config.test.js || npx jest tests/unit/gateway-config.test.js
