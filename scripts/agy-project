#!/bin/bash
# agy-project - Enhanced with job tracking, notifications, and structured results
# Usage: agy-project <repo-url-or-name> [initial-prompt]
#        agy-project status
#        agy-project logs <job-id>
#        agy-project result <job-id>
#        agy-project attach <job-id>

set -euo pipefail

# Source common library for colors and utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/common.sh
if [[ -f "$SCRIPT_DIR/lib/common.sh" ]]; then
    source "$SCRIPT_DIR/lib/common.sh"
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    BLUE='\033[0;34m'
    YELLOW='\033[0;33m'
    NC='\033[0m'
fi

TW_CONTROL="$HOME/bin/tw"
# Use \$HOME so it expands on the remote machine, not locally
PROJECTS_DIR="\$HOME/Development/Projects"
JOBS_DIR="\$HOME/Development/.agy-jobs"

usage() {
    echo "Usage: agy-project <repo-url-or-name> [initial-prompt]"
    echo "       agy-project status"
    echo "       agy-project logs <job-id>"
    echo "       agy-project result <job-id>"
    echo "       agy-project attach <job-id>"
    echo ""
    echo "Examples:"
    echo "  agy-project git@github.com:you/myapp.git              # Clone new repo"
    echo "  agy-project git@github.com:you/myapp.git \"Review code\" # Clone + task"
    echo "  agy-project myapp                                      # Open existing"
    echo "  agy-project myapp \"Implement feature X\"               # Task existing"
    echo ""
    echo "Job management:"
    echo "  agy-project status                  # View all jobs"
    echo "  agy-project logs <job-id>           # View job logs"
    echo "  agy-project result <job-id>         # Get structured result"
    echo "  agy-project attach <job-id>         # Attach to live session"
    exit 1
}

[ -z "$1" ] && usage

# Handle subcommands
case "$1" in
    status)
        exec "$TW_CONTROL" run "~/bin/agy-jobs status"
        ;;
    logs)
        [ -n "$2" ] || { echo "Error: job-id required"; exit 1; }
        exec "$TW_CONTROL" run "~/bin/agy-jobs logs '$2'"
        ;;
    result)
        [ -n "$2" ] || { echo "Error: job-id required"; exit 1; }
        exec "$TW_CONTROL" run "~/bin/agy-jobs result '$2'"
        ;;
    attach)
        [ -n "$2" ] || { echo "Error: job-id required"; exit 1; }
        echo -e "${YELLOW}Attaching to job $2...${NC}"
        echo -e "${BLUE}Detach with: Ctrl-b d${NC}"
        exec "$TW_CONTROL" run "tmux attach-session -t 'agy-$2'"
        ;;
esac

INPUT="$1"
PROMPT="${2:-}"

# Determine if input is URL or project name
if [[ "$INPUT" =~ ^(git@|https://) ]]; then
    IS_URL=true
    PROJECT_NAME=$(basename "$INPUT" .git)
else
    IS_URL=false
    PROJECT_NAME="$INPUT"
fi

# Sanitize project name to prevent command injection
if [[ ! "$PROJECT_NAME" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    echo -e "${RED}Error: Invalid project name '$PROJECT_NAME'${NC}"
    echo "Project names may only contain letters, numbers, dots, underscores, and hyphens."
    exit 1
fi

# Generate job ID
JOB_ID="$PROJECT_NAME-$(date +%Y%m%d-%H%M%S)"
SESSION_NAME="agy-$JOB_ID"

echo -e "${BLUE}=== AntiGravity Project Setup (Job-Tracked) ===${NC}"
echo -e "Job ID:   ${GREEN}$JOB_ID${NC}"
echo -e "Project:  ${GREEN}$PROJECT_NAME${NC}"
echo -e "Session:  ${GREEN}$SESSION_NAME${NC}"
echo ""

# Check TW Mac connectivity
echo -e "${YELLOW}Checking TW Mac connection...${NC}"
if ! "$TW_CONTROL" run 'echo ok' >/dev/null 2>&1; then
    echo -e "${RED}Error: TW Mac not reachable${NC}"
    echo "Run: ~/bin/tw status"
    exit 1
fi
echo -e "${GREEN}âœ“ TW Mac connected${NC}"

# Escape prompt for safe transmission (both for shell and sed)
# First escape backslashes, then &, then /, then single quotes
ESCAPED_PROMPT=$(printf '%s' "$PROMPT" | sed -e 's/\\/\\\\/g' -e 's/&/\\&/g' -e 's|/|\\/|g' -e "s/'/'\\\\''/g")

# Create job execution script on TW Mac
echo -e "${YELLOW}Creating job wrapper...${NC}"

"$TW_CONTROL" run "cat > /tmp/agy-job-${JOB_ID}.sh && chmod +x /tmp/agy-job-${JOB_ID}.sh" << 'EOJOB'
#!/bin/bash
set -e

JOB_ID="__JOB_ID__"
PROJECT_NAME="__PROJECT_NAME__"
INPUT="__INPUT__"
IS_URL="__IS_URL__"
SESSION_NAME="__SESSION_NAME__"
PROMPT='__PROMPT__'
PROJECTS_DIR="__PROJECTS_DIR__"
JOBS_DIR="__JOBS_DIR__"

# Create job directory
mkdir -p "${JOBS_DIR}/${JOB_ID}"

# Create metadata
cat > "${JOBS_DIR}/${JOB_ID}/meta.json" << 'EOMETA'
{
  "job_id": "__JOB_ID__",
  "project": "__PROJECT_NAME__",
  "status": "submitted",
  "start_time": "__START_TIME__",
  "tmux_session": "__SESSION_NAME__"
}
EOMETA

# Redirect to log file
exec > "${JOBS_DIR}/${JOB_ID}/job.log" 2>&1

echo "=== JOB START: ${JOB_ID} ==="
echo "Project: ${PROJECT_NAME}"
echo "Time: $(date)"
echo ""

# Update status function
update_status() {
    local status="$1"
    jq --arg status "$status" --arg time "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
        '.status = $status | .last_update = $time' \
        "${JOBS_DIR}/${JOB_ID}/meta.json" > "${JOBS_DIR}/${JOB_ID}/meta.json.tmp"
    mv "${JOBS_DIR}/${JOB_ID}/meta.json.tmp" "${JOBS_DIR}/${JOB_ID}/meta.json"
}

fail_job() {
    update_status "failed"
    echo "âŒ FAILED: $1"
    exit 1
}

update_status "running"

# Clone or verify project exists
if [ "$IS_URL" = "true" ]; then
    echo "ðŸ”¹ Checking if project exists..."
    if [ -d "${PROJECTS_DIR}/${PROJECT_NAME}" ]; then
        echo "âœ“ Project already exists, pulling latest..."
        cd "${PROJECTS_DIR}/${PROJECT_NAME}"
        git pull 2>&1 || echo "âš ï¸  Warning: git pull failed"
    else
        echo "ðŸ”¹ Cloning repository..."
        cd "${PROJECTS_DIR}"
        git clone "$INPUT" 2>&1 || fail_job "Git clone failed"
        echo "âœ“ Repository cloned"
    fi
else
    if [ ! -d "${PROJECTS_DIR}/${PROJECT_NAME}" ]; then
        fail_job "Project '${PROJECT_NAME}' not found in ${PROJECTS_DIR}"
    fi
    echo "âœ“ Project found"
fi

# Run project-setup.sh if exists
echo "ðŸ”¹ Checking for project setup script..."
if [ -x "${PROJECTS_DIR}/${PROJECT_NAME}/scripts/project-setup.sh" ]; then
    echo "ðŸ”¹ Running project-setup.sh..."
    cd "${PROJECTS_DIR}/${PROJECT_NAME}"
    if timeout 60s ./scripts/project-setup.sh 2>&1; then
        echo "âœ“ Setup complete"
    else
        echo "âš ï¸  Warning: project-setup.sh failed or timed out"
    fi
else
    echo "â„¹ï¸  No setup script found (optional)"
fi

# Setup direnv if .envrc exists
if [ -f "${PROJECTS_DIR}/${PROJECT_NAME}/.envrc" ]; then
    echo "ðŸ”¹ Configuring direnv..."
    cd "${PROJECTS_DIR}/${PROJECT_NAME}"
    direnv allow 2>&1 || echo "âš ï¸  Warning: direnv allow failed"
fi

# Check if session already exists
echo "ðŸ”¹ Setting up tmux session..."
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "â„¹ï¸  Session '$SESSION_NAME' already exists (reusing)"
else
    # Start tmux with bash to avoid zshrc's 1Password integration issues
    tmux new-session -d -s "$SESSION_NAME" "cd '${PROJECTS_DIR}/${PROJECT_NAME}' && exec /bin/bash --login"
    echo "âœ“ Session created"

    # Wait for bash prompt
    echo "ðŸ”¹ Waiting for shell..."
    for i in {1..10}; do
        pane_content=$(tmux capture-pane -t "$SESSION_NAME" -p 2>/dev/null | tail -2)
        if echo "$pane_content" | grep -qE '(\$|>)\s*$'; then
            break
        fi
        sleep 1
    done

    # Source nvm and start Claude (full path ensures no shell alias interference)
    tmux send-keys -t "$SESSION_NAME" 'export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"; claude' Enter
    echo "âœ“ Claude started"

    # Wait for Claude to initialize
    for i in {1..15}; do
        pane_content=$(tmux capture-pane -t "$SESSION_NAME" -p 2>/dev/null | tail -3)
        if echo "$pane_content" | grep -qiE '(claude|project|working)'; then
            break
        fi
        sleep 1
    done
    sleep 2
fi

# Send prompt if provided
if [ -n "$PROMPT" ]; then
    echo "ðŸ”¹ Sending prompt..."
    tmux send-keys -t "$SESSION_NAME" -l "$PROMPT"
    tmux send-keys -t "$SESSION_NAME" Enter
    echo "âœ“ Prompt sent"
fi

update_status "running"

# Send notification
if command -v ~/bin/agy-notify &>/dev/null; then
    ~/bin/agy-notify "Job ${JOB_ID} started" "${PROJECT_NAME}" || true
fi

echo ""
echo "âœ“ Job running"
echo "=== END SETUP ==="
EOJOB

# Substitute variables in the heredoc we just sent
"$TW_CONTROL" run "sed -i.bak \
    -e 's|__JOB_ID__|${JOB_ID}|g' \
    -e 's|__PROJECT_NAME__|${PROJECT_NAME}|g' \
    -e 's|__INPUT__|${INPUT}|g' \
    -e 's|__IS_URL__|${IS_URL}|g' \
    -e 's|__SESSION_NAME__|${SESSION_NAME}|g' \
    -e 's|__PROMPT__|${ESCAPED_PROMPT}|g' \
    -e 's|__PROJECTS_DIR__|${PROJECTS_DIR}|g' \
    -e 's|__JOBS_DIR__|${JOBS_DIR}|g' \
    -e 's|__START_TIME__|$(date -u +%Y-%m-%dT%H:%M:%SZ)|g' \
    /tmp/agy-job-${JOB_ID}.sh"

# Execute job in background
echo -e "${YELLOW}Submitting job to TW Mac...${NC}"
"$TW_CONTROL" run "nohup /tmp/agy-job-${JOB_ID}.sh > /dev/null 2>&1 &"

# Wait for job metadata to be created
echo -e "${YELLOW}Verifying job submission...${NC}"
for i in {1..10}; do
    if "$TW_CONTROL" run "[ -f ${JOBS_DIR}/${JOB_ID}/meta.json ]" 2>/dev/null; then
        break
    fi
    sleep 1
done

echo ""
echo -e "${GREEN}=== Job Submitted ===${NC}"
echo -e "Job ID:  ${BLUE}$JOB_ID${NC}"
echo -e "Project: ${BLUE}$PROJECT_NAME${NC}"
echo ""
echo -e "${YELLOW}Quick commands:${NC}"
echo "  Status:   agy-project status"
echo "  Logs:     agy-project logs $JOB_ID"
echo "  Result:   agy-project result $JOB_ID"
echo "  Attach:   agy-project attach $JOB_ID"
echo ""
echo -e "${YELLOW}Legacy tmux commands (if needed):${NC}"
echo "  View:     ~/bin/tw run 'tmux capture-pane -t \"$SESSION_NAME\" -p | tail -50'"
echo "  Attach:   ~/bin/tw tmux  # then Ctrl-b, s to select"
echo "  Kill:     ~/bin/tw run 'tmux kill-session -t \"$SESSION_NAME\"'"
