#!/bin/bash
# Pre-commit hook: Security scanning + Auto-dispatch linting to TW Mac
# Install: ln -sf $(pwd)/infrastructure/tw-mac/automation/git-hooks/pre-commit .git/hooks/pre-commit

set -e

HOOK_DIR="$(dirname "$0")"
TW_CONTROL="$HOME/bin/tw"

#------------------------------------------------------------------------------
# SECURITY: Credential Leak Prevention
#------------------------------------------------------------------------------
echo "Pre-commit: Scanning for credentials..."

# Patterns that indicate leaked secrets
CREDENTIAL_PATTERNS=(
    'sk-ant-api[0-9]{2}-[A-Za-z0-9_-]{20,}'    # Anthropic API keys
    'sk-[A-Za-z0-9]{20,}'                       # OpenAI API keys
    'AKIA[0-9A-Z]{16}'                          # AWS Access Key IDs
    'ghp_[A-Za-z0-9]{36}'                       # GitHub Personal Access Tokens
    'gho_[A-Za-z0-9]{36}'                       # GitHub OAuth tokens
    'github_pat_[A-Za-z0-9_]{22,}'              # GitHub Fine-grained PATs
    'xox[baprs]-[A-Za-z0-9-]{10,}'              # Slack tokens
    '-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----'  # Private keys
)

# Build combined regex
COMBINED_PATTERN=$(IFS='|'; echo "${CREDENTIAL_PATTERNS[*]}")

# Check staged content (not filenames)
if git diff --cached --diff-filter=ACM -U0 | grep -E "$COMBINED_PATTERN" | grep -v '^[+-].*op://' >/dev/null 2>&1; then
    echo ""
    echo "ERROR: Potential credentials detected in staged changes!"
    echo ""
    echo "Matches found:"
    git diff --cached --diff-filter=ACM -U0 | grep -E "$COMBINED_PATTERN" | grep -v '^[+-].*op://' | head -5
    echo ""
    echo "If these are intentional (e.g., documentation examples), use:"
    echo "  git commit --no-verify"
    echo ""
    echo "Otherwise, remove the credentials and use 1Password references:"
    echo "  ANTHROPIC_API_KEY=op://Developer/Anthropic Claude/API Key"
    echo ""
    exit 1
fi

echo "Pre-commit: No credentials detected"

#------------------------------------------------------------------------------
# LINTING: Dispatch to TW Mac (optional)
#------------------------------------------------------------------------------

# Check if TW Mac is available
if ! "$TW_CONTROL" run 'echo ok' >/dev/null 2>&1; then
    echo "TW Mac not available, skipping parallel lint"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Count file types
JS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|jsx|tsx)$' | wc -l | tr -d ' ')
PY_FILES=$(echo "$STAGED_FILES" | grep -E '\.py$' | wc -l | tr -d ' ')
SH_FILES=$(echo "$STAGED_FILES" | grep -E '\.sh$' | wc -l | tr -d ' ')

echo "Pre-commit: Dispatching checks to TW Mac..."

# Dispatch appropriate linting based on file types
if [ "$JS_FILES" -gt 0 ]; then
    "$TW_CONTROL" run "cd ~/Development/Projects/clawdbot && npm run lint 2>&1" &
    LINT_PID=$!
fi

if [ "$SH_FILES" -gt 0 ]; then
    # Convert newlines to spaces for shellcheck argument list
    SH_FILE_LIST=$(echo "$STAGED_FILES" | grep -E '\.sh$' | tr '\n' ' ')
    "$TW_CONTROL" run "cd ~/Development/Projects/clawdbot && shellcheck $SH_FILE_LIST 2>&1" &
fi

# Wait for lint to complete if started
if [ -n "$LINT_PID" ]; then
    wait $LINT_PID
    LINT_EXIT=$?
    if [ $LINT_EXIT -ne 0 ]; then
        echo "Lint failed on TW Mac"
        exit 1
    fi
fi

echo "Pre-commit checks passed"
exit 0
