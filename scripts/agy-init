#!/bin/bash
# agy-init - Bootstrap a project for Antigravity Zero-Command integration
#
# Usage:
#   agy-init                    # Initialize current directory
#   agy-init /path/to/project   # Initialize specific project
#   agy-init --help             # Show help
#
# Creates:
#   .antigravity/config.json    - Project configuration
#   .vscode/tasks.json          - Auto-run task on folder open
#   scripts/agy-auto-setup      - Setup script (if not exists)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEV_INFRA_DIR="$(dirname "$SCRIPT_DIR")"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_help() {
    cat << 'EOF'
agy-init - Bootstrap Antigravity Zero-Command integration

USAGE:
    agy-init [OPTIONS] [PROJECT_PATH]

ARGUMENTS:
    PROJECT_PATH    Path to project (default: current directory)

OPTIONS:
    -n, --name NAME     Project name (default: directory name)
    -f, --force         Overwrite existing config
    --no-tasks          Skip .vscode/tasks.json creation
    --no-setup          Skip agy-auto-setup script copy
    -h, --help          Show this help

EXAMPLES:
    agy-init                           # Initialize current directory
    agy-init ~/Projects/myapp          # Initialize specific project
    agy-init -n "My App" .             # Set custom project name
    agy-init --force                   # Reinitialize existing project

EOF
}

# Defaults
PROJECT_PATH="."
PROJECT_NAME=""
FORCE=false
CREATE_TASKS=true
CREATE_SETUP=true

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--name)
            PROJECT_NAME="$2"
            shift 2
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        --no-tasks)
            CREATE_TASKS=false
            shift
            ;;
        --no-setup)
            CREATE_SETUP=false
            shift
            ;;
        -h|--help)
            print_help
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            print_help
            exit 1
            ;;
        *)
            PROJECT_PATH="$1"
            shift
            ;;
    esac
done

# Resolve project path
PROJECT_PATH="$(cd "$PROJECT_PATH" && pwd)"
PROJECT_NAME="${PROJECT_NAME:-$(basename "$PROJECT_PATH")}"

echo -e "${BLUE}Initializing Antigravity for:${NC} $PROJECT_NAME"
echo -e "${BLUE}Path:${NC} $PROJECT_PATH"
echo ""

# Check if already initialized
if [ -f "$PROJECT_PATH/.antigravity/config.json" ] && [ "$FORCE" != true ]; then
    echo -e "${YELLOW}Project already initialized.${NC}"
    echo "Use --force to reinitialize."
    exit 0
fi

# Create .antigravity directory
mkdir -p "$PROJECT_PATH/.antigravity"

# Create config.json
echo -e "${GREEN}Creating${NC} .antigravity/config.json"
cat > "$PROJECT_PATH/.antigravity/config.json" << EOF
{
  "\$schema": "./config.schema.json",
  "version": "3.0",
  "project": {
    "name": "$PROJECT_NAME",
    "description": "",
    "techStack": []
  },
  "onOpen": {
    "setupScript": "scripts/agy-auto-setup",
    "allowDirenv": true,
    "validateSecrets": true,
    "checkMcpHealth": true,
    "notification": {
      "enabled": true,
      "successMessage": "$PROJECT_NAME ready",
      "sound": "Glass"
    }
  },
  "secrets": [],
  "mcp": {
    "autoLoad": true,
    "servers": {}
  },
  "claude": {
    "autoStart": false,
    "contextFiles": ["CLAUDE.md", "README.md"],
    "defaultModel": "claude-sonnet-4-20250514"
  },
  "environment": {
    "required": [],
    "optional": []
  }
}
EOF

# Copy schema file
echo -e "${GREEN}Creating${NC} .antigravity/config.schema.json"
cp "$DEV_INFRA_DIR/.antigravity/config.schema.json" "$PROJECT_PATH/.antigravity/" 2>/dev/null || \
    echo -e "${YELLOW}Schema file not found, skipping${NC}"

# Create .vscode/tasks.json
if [ "$CREATE_TASKS" = true ]; then
    mkdir -p "$PROJECT_PATH/.vscode"

    if [ -f "$PROJECT_PATH/.vscode/tasks.json" ] && [ "$FORCE" != true ]; then
        echo -e "${YELLOW}Skipping${NC} .vscode/tasks.json (exists, use --force)"
    else
        echo -e "${GREEN}Creating${NC} .vscode/tasks.json"
        cat > "$PROJECT_PATH/.vscode/tasks.json" << 'EOF'
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "AGY Auto-Setup",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/agy-auto-setup",
      "runOptions": {
        "runOn": "folderOpen"
      },
      "presentation": {
        "reveal": "silent",
        "panel": "shared",
        "showReuseMessage": false,
        "close": true
      },
      "problemMatcher": []
    }
  ]
}
EOF
    fi
fi

# Copy agy-auto-setup script
if [ "$CREATE_SETUP" = true ]; then
    mkdir -p "$PROJECT_PATH/scripts"

    if [ -f "$PROJECT_PATH/scripts/agy-auto-setup" ] && [ "$FORCE" != true ]; then
        echo -e "${YELLOW}Skipping${NC} scripts/agy-auto-setup (exists, use --force)"
    else
        echo -e "${GREEN}Creating${NC} scripts/agy-auto-setup"
        cp "$DEV_INFRA_DIR/scripts/agy-auto-setup" "$PROJECT_PATH/scripts/"
        chmod +x "$PROJECT_PATH/scripts/agy-auto-setup"
    fi
fi

# Create .envrc if it doesn't exist
if [ ! -f "$PROJECT_PATH/.envrc" ]; then
    echo -e "${GREEN}Creating${NC} .envrc template"
    cat > "$PROJECT_PATH/.envrc" << EOF
#!/usr/bin/env bash
# Project: $PROJECT_NAME

export PROJECT_NAME="$PROJECT_NAME"
export PROJECT_ROOT="$PROJECT_PATH"

echo "✅ Loaded $PROJECT_NAME environment"
EOF
fi

echo ""
echo -e "${GREEN}✅ Antigravity initialized!${NC}"
echo ""
echo "Next steps:"
echo "  1. Edit .antigravity/config.json to add secrets and MCP servers"
echo "  2. Edit .envrc to add environment variables"
echo "  3. Run 'direnv allow' to enable the environment"
echo "  4. Open project in Antigravity - setup runs automatically"
echo ""
