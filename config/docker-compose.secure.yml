version: "3.8"

services:
  clawdbot-gateway:
    build:
      context: .
      dockerfile: config/Dockerfile.secure
      args:
        USER_ID: ${USER_UID:-1000}
        GROUP_ID: ${USER_GID:-1000}
    image: clawdbot/gateway:secure
    container_name: clawdbot-gateway-secure
    restart: unless-stopped

    # SECURITY: Network isolation
    networks:
      - clawdbot-internal
    ports:
      - "127.0.0.1:18789:18789" # Clawdbot default port

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
          pids: 100
        reservations:
          cpus: "0.5"
          memory: 512M

    # SECURITY: Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=512M,noexec,nosuid,nodev
      - /run:mode=755,size=128M,noexec,nosuid,nodev
      - /home/clawdbot/.npm:mode=755,size=256M

    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    # SECURITY: No privileged mode
    privileged: false

    # SECURITY: Prevent privilege escalation
    security_opt:
      - no-new-privileges:true
      - seccomp=config/seccomp-profile.json

    # SECURITY: Run as non-root user
    user: "${USER_UID:-1000}:${USER_GID:-1000}"

    # SECURITY: Writable volumes (minimal)
    volumes:
      - clawdbot-config:/home/clawdbot/.clawdbot:rw
      - clawdbot-logs:/home/clawdbot/logs:rw

    # Environment variables
    environment:
      - NODE_ENV=production
      - CLAWDBOT_PORT=18789
      - HOME=/home/clawdbot
      - CLAWDBOT_STATE_DIR=/home/clawdbot/.clawdbot

    # SECURITY: Health check
    healthcheck:
      test:
        ["CMD", "sh", "-c", "curl -f http://localhost:18789/health || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Run gateway command
    command: ["gateway", "--port", "18789"]

  clawdbot-cli:
    build:
      context: .
      dockerfile: config/Dockerfile.secure
      args:
        USER_ID: ${USER_UID:-1000}
        GROUP_ID: ${USER_GID:-1000}
    image: clawdbot/cli:secure
    container_name: clawdbot-cli-secure

    # SECURITY: Network isolation
    networks:
      - clawdbot-internal

    # SECURITY: Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=256M,noexec,nosuid,nodev
      - /home/clawdbot/.npm:mode=755,size=128M

    # SECURITY: Minimal capabilities
    cap_drop:
      - ALL

    # SECURITY: No privileged mode
    privileged: false
    security_opt:
      - no-new-privileges:true

    # SECURITY: Run as non-root
    user: "${USER_UID:-1000}:${USER_GID:-1000}"

    # SECURITY: Shared volumes
    volumes:
      - clawdbot-config:/home/clawdbot/.clawdbot:rw

    environment:
      - HOME=/home/clawdbot
      - CLAWDBOT_STATE_DIR=/home/clawdbot/.clawdbot

    # CLI entrypoint
    entrypoint: ["/usr/bin/dumb-init", "--", "clawdbot"]

    # Don't run by default (use for commands only)
    profiles:
      - tools

networks:
  clawdbot-internal:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: clawdbot0
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

volumes:
  clawdbot-config:
    driver: local
  clawdbot-logs:
    driver: local
