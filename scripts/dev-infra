#!/bin/bash
# dev-infra - Main CLI for development infrastructure management
# Manages secrets, MCP servers, project scaffolding, and agent coordination

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
DEV_INFRA_ROOT="$(dirname "$SCRIPT_DIR")"
SECRETS_CACHE="${XDG_RUNTIME_DIR:-/tmp}/dev-infra-secrets"
SECRETS_CACHE_TTL=3600  # 1 hour

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}ℹ${NC} $*"; }
log_success() { echo -e "${GREEN}✓${NC} $*"; }
log_warn() { echo -e "${YELLOW}⚠${NC} $*"; }
log_error() { echo -e "${RED}✗${NC} $*" >&2; }

# Check if secrets cache is fresh
cache_is_fresh() {
    local cache_file="$1"
    if [ ! -f "$cache_file" ]; then
        return 1
    fi
    local cache_age=$(($(date +%s) - $(stat -f %m "$cache_file" 2>/dev/null || echo 0)))
    [ "$cache_age" -lt "$SECRETS_CACHE_TTL" ]
}

# Get secret from cache or 1Password
get_secret() {
    local ref="$1"
    local cache_key=$(echo "$ref" | md5 -q)
    local cache_file="$SECRETS_CACHE/$cache_key"

    mkdir -p "$SECRETS_CACHE"
    chmod 700 "$SECRETS_CACHE"

    if cache_is_fresh "$cache_file"; then
        cat "$cache_file"
        return 0
    fi

    local value
    if value=$(op read "$ref" 2>/dev/null); then
        echo "$value" > "$cache_file"
        chmod 600 "$cache_file"
        echo "$value"
    else
        log_error "Failed to read secret: $ref"
        return 1
    fi
}

# Refresh all secrets cache
cmd_secrets_refresh() {
    log_info "Refreshing secrets cache..."
    exec "$SCRIPT_DIR/secrets-refresh.sh" "$@"
}

# Clear secrets cache
cmd_secrets_clear() {
    if [ -d "$SECRETS_CACHE" ]; then
        rm -rf "$SECRETS_CACHE"
        log_success "Secrets cache cleared"
    else
        log_info "No cache to clear"
    fi
}

# Launch MCP server with secrets
cmd_mcp() {
    local server="$1"
    shift
    exec "$SCRIPT_DIR/mcp-launcher.sh" "$server" "$@"
}

# Initialize new project from template
cmd_init() {
    local project_name="$1"
    local template="${2:-default}"
    local projects_dir="$HOME/Development/Projects"
    local project_path="$projects_dir/$project_name"

    if [ -z "$project_name" ]; then
        log_error "Usage: dev-infra init <project-name> [template]"
        echo "Templates: default, api, cli, library"
        exit 1
    fi

    if [ -d "$project_path" ]; then
        log_error "Project already exists: $project_path"
        exit 1
    fi

    log_info "Creating project: $project_name (template: $template)"

    mkdir -p "$project_path"

    # Copy template files (including dotfiles)
    local template_dir="$DEV_INFRA_ROOT/templates/project/$template"
    if [ -d "$template_dir" ]; then
        cp -R "$template_dir/"* "$project_path/" 2>/dev/null || true
        cp -R "$template_dir/".* "$project_path/" 2>/dev/null || true
    else
        # Use default template inline
        cat > "$project_path/.envrc" << 'EOF'
# direnv configuration
# Loads automatically when entering directory

# Source dev-infra environment
source_env_if_exists ~/.config/dev-infra/env.sh

# Project-specific environment
export PROJECT_NAME="$(basename $PWD)"

# 1Password secrets (loaded via dev-infra)
export_function get_secret() {
    dev-infra secret "$1"
}
EOF

        cat > "$project_path/CLAUDE.md" << EOF
# Claude Rules: $project_name

## Project Overview
**Purpose:** [Describe project purpose]
**Tech Stack:** [List technologies]

## Workflow Rules
- Use dev-infra for secrets management
- Follow project conventions

## Commands
\`\`\`bash
dev-infra secrets refresh  # Refresh secret cache
dev-infra mcp <server>     # Launch MCP server
\`\`\`
EOF

        mkdir -p "$project_path/src" "$project_path/tests" "$project_path/scripts"
    fi

    # Substitute project name in templates
    find "$project_path" -type f -exec sed -i '' "s/{{PROJECT_NAME}}/$project_name/g" {} \; 2>/dev/null || true

    log_success "Project created: $project_path"
    log_info "Next steps:"
    echo "  cd $project_path"
    echo "  direnv allow"
    echo "  agy"
}

# Health check
cmd_health() {
    echo "=== Dev Infrastructure Health ==="
    echo

    # 1Password
    echo -n "1Password CLI: "
    if command -v op &>/dev/null; then
        echo -e "${GREEN}installed${NC}"
        echo -n "  Auth: "
        # Check for service account token
        local token_file="$HOME/.config/op/claude-dev-token"
        if [ -n "$OP_SERVICE_ACCOUNT_TOKEN" ]; then
            if OP_SERVICE_ACCOUNT_TOKEN="$OP_SERVICE_ACCOUNT_TOKEN" op whoami &>/dev/null; then
                echo -e "${GREEN}service account${NC}"
            else
                echo -e "${YELLOW}token invalid${NC}"
            fi
        elif [ -f "$token_file" ]; then
            if OP_SERVICE_ACCOUNT_TOKEN=$(cat "$token_file") op whoami &>/dev/null; then
                echo -e "${GREEN}service account (file)${NC}"
            else
                echo -e "${YELLOW}token file invalid${NC}"
            fi
        elif op whoami &>/dev/null; then
            echo -e "${GREEN}interactive session${NC}"
        else
            echo -e "${YELLOW}not authenticated${NC}"
        fi
    else
        echo -e "${RED}not installed${NC}"
    fi

    # direnv
    echo -n "direnv: "
    if command -v direnv &>/dev/null; then
        echo -e "${GREEN}installed${NC}"
    else
        echo -e "${YELLOW}not installed${NC}"
    fi

    # Claude Code
    echo -n "Claude Code: "
    if command -v claude &>/dev/null; then
        echo -e "${GREEN}installed${NC}"
    else
        echo -e "${RED}not installed${NC}"
    fi

    # Agent connectivity
    echo -n "Agent Alpha (TW Mac): "
    if ssh -o ConnectTimeout=2 tw "echo ok" &>/dev/null; then
        echo -e "${GREEN}connected${NC}"
    else
        echo -e "${YELLOW}unreachable${NC}"
    fi

    # Secrets cache
    echo -n "Secrets cache: "
    if [ -d "$SECRETS_CACHE" ]; then
        local count=$(find "$SECRETS_CACHE" -type f | wc -l | tr -d ' ')
        echo -e "${GREEN}$count items cached${NC}"
    else
        echo -e "${YELLOW}empty${NC}"
    fi

    echo
    echo "=== End Health Check ==="
}

# Sync configuration to agent
cmd_sync() {
    local target="${1:-alpha}"
    log_info "Syncing to agent: $target"

    case "$target" in
        alpha|tw)
            # Sync 1Password token
            scp ~/.config/op/claude-dev-token tw:~/.config/op/service-account-token
            ssh tw "chmod 600 ~/.config/op/service-account-token"

            # Verify
            if ssh tw 'export OP_SERVICE_ACCOUNT_TOKEN=$(cat ~/.config/op/service-account-token) && op whoami' &>/dev/null; then
                log_success "1Password token synced and verified"
            else
                log_error "Token sync failed"
                exit 1
            fi
            ;;
        *)
            log_error "Unknown agent: $target"
            exit 1
            ;;
    esac
}

# Show usage
usage() {
    cat << EOF
dev-infra - Development Infrastructure CLI

Usage: dev-infra <command> [options]

Commands:
  secrets refresh     Refresh secrets cache from 1Password
  secrets clear       Clear the secrets cache
  secret <ref>        Get a single secret (cached)

  mcp <server>        Launch MCP server with secrets injected

  init <name> [tpl]   Initialize new project from template
  health              Check infrastructure health
  sync [agent]        Sync configuration to agent

  help                Show this help

Examples:
  dev-infra secrets refresh           # Cache all secrets
  dev-infra secret "op://vault/item"  # Get specific secret
  dev-infra mcp github                # Launch GitHub MCP
  dev-infra init my-api api           # Create new API project
  dev-infra sync alpha                # Sync to TW Mac
EOF
}

# Main dispatch
case "${1:-}" in
    secrets)
        case "${2:-}" in
            refresh) shift 2; cmd_secrets_refresh "$@" ;;
            clear) cmd_secrets_clear ;;
            *) usage; exit 1 ;;
        esac
        ;;
    secret)
        shift
        get_secret "$@"
        ;;
    mcp)
        shift
        cmd_mcp "$@"
        ;;
    init)
        shift
        cmd_init "$@"
        ;;
    health)
        cmd_health
        ;;
    sync)
        shift
        cmd_sync "$@"
        ;;
    help|--help|-h|"")
        usage
        ;;
    *)
        log_error "Unknown command: $1"
        usage
        exit 1
        ;;
esac
