# Docker Compose configuration for secure Clawdbot deployment
# Uses YAML anchors to reduce duplication between services

#------------------------------------------------------------------------------
# Shared Configuration (YAML Anchors)
#------------------------------------------------------------------------------
x-common-build: &common-build
  context: ..
  dockerfile: config/Dockerfile.secure
  args:
    USER_ID: ${USER_UID:-1000}
    GROUP_ID: ${USER_GID:-1000}
    # SECURITY: Pin version to prevent supply chain attacks
    CLAWDBOT_VERSION: ${CLAWDBOT_VERSION:-2026.1.23-1}

x-common-security: &common-security
  # SECURITY: Read-only root filesystem
  read_only: true
  # SECURITY: Drop all capabilities
  cap_drop:
    - ALL
  # SECURITY: No privileged mode
  privileged: false
  # SECURITY: Prevent privilege escalation
  security_opt:
    - no-new-privileges:true
    # NOTE: Custom seccomp profile disabled for macOS Docker Desktop compatibility.
    # macOS Docker runs containers in a Linux VM where custom seccomp profiles
    # cause "operation not permitted" errors. The default Docker seccomp profile
    # still provides syscall filtering. Enable on Linux hosts for stricter security:
    # - seccomp=seccomp-profile.json

x-common-logging: &common-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

#------------------------------------------------------------------------------
# Services
#------------------------------------------------------------------------------
services:
  clawdbot-gateway:
    build: *common-build
    image: clawdbot/gateway:secure
    container_name: clawdbot-gateway-secure
    restart: unless-stopped

    # SECURITY: Network isolation
    networks:
      - clawdbot-internal
    ports:
      - "127.0.0.1:18789:18789" # Clawdbot gateway port
      - "127.0.0.1:18791:18791" # Browser control interface

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
          pids: 100
        reservations:
          cpus: "0.5"
          memory: 512M

    # Include shared security settings
    <<: *common-security
    # Gateway needs NET_BIND_SERVICE capability
    cap_add:
      - NET_BIND_SERVICE

    tmpfs:
      # SECURITY: Use mode=1770 (sticky bit, owner+group writable) instead of world-writable 1777
      - /tmp:mode=1770,size=512M,noexec,nosuid,nodev,uid=1000,gid=1000
      - /run:mode=0750,size=128M,noexec,nosuid,nodev,uid=1000,gid=1000
      - /home/node/.npm:mode=0750,size=256M,uid=1000,gid=1000
      - /home/node/clawd:mode=0750,size=256M,uid=1000,gid=1000

    # SECURITY: Run as non-root user (matching host UID for volume permissions)
    user: "${USER_UID:-501}:${USER_GID:-20}"

    # SECURITY: Writable volumes (minimal)
    # Optional host mounts can be added via docker-compose.override.yml
    volumes:
      - clawdbot-config:/home/node/.clawdbot:rw
      - clawdbot-logs:/home/node/logs:rw

    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Environment variables (secrets from 1Password or .env)
    environment:
      - NODE_ENV=production
      - CLAWDBOT_PORT=18789
      - HOME=/home/node
      - CLAWDBOT_STATE_DIR=/home/node/.clawdbot
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # SECURITY: Gateway token is required - no weak default
      - CLAWDBOT_GATEWAY_TOKEN=${CLAWDBOT_GATEWAY_TOKEN:?CLAWDBOT_GATEWAY_TOKEN must be set in .env}

    # SECURITY: Health check
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:18789/health || exit 1"]
      <<: *common-healthcheck

    logging: *common-logging

    # Run gateway command
    # SECURITY: Bind to localhost only (not lan) to prevent network exposure
    command:
      [
        "clawdbot",
        "gateway",
        "--port",
        "18789",
        "--bind",
        "localhost",
        "--allow-unconfigured",
        "--token",
        "${CLAWDBOT_GATEWAY_TOKEN}",
      ]

  clawdbot-cli:
    build: *common-build
    image: clawdbot/cli:secure
    container_name: clawdbot-cli-secure

    # SECURITY: Network isolation
    networks:
      - clawdbot-internal

    # Include shared security settings
    <<: *common-security

    tmpfs:
      # SECURITY: Use restricted permissions instead of world-writable
      - /tmp:mode=1770,size=256M,noexec,nosuid,nodev,uid=1000,gid=1000
      - /home/node/.npm:mode=0750,size=128M,uid=1000,gid=1000

    # SECURITY: Run as non-root
    user: "1000:1000"

    # SECURITY: Shared volumes
    volumes:
      - clawdbot-config:/home/node/.clawdbot:rw

    environment:
      - HOME=/home/node
      - CLAWDBOT_STATE_DIR=/home/node/.clawdbot

    # CLI entrypoint
    entrypoint: ["/usr/bin/dumb-init", "--", "clawdbot"]

    # Don't run by default (use for commands only)
    profiles:
      - tools

networks:
  clawdbot-internal:
    driver: bridge

volumes:
  clawdbot-config:
    driver: local
  clawdbot-logs:
    driver: local
